---
export interface Props {
    resources?: Record<string, Record<string, { pdf?: string; mscz?: string; ogg?: string }>>;
}

const { resources = {} } = Astro.props;


---

<div class="resources-section mt-12">
    <h2 class="text-3xl font-serif font-medium mb-12 text-center">Recursos Musicales</h2>

    <!-- Loading indicator -->
    <div id="resources-loading" class="text-center py-8" style="display: none;">
        <p class="text-sm text-muted">Cargando recursos...</p>
    </div>

    <!-- Error message -->
    <div id="resources-error" class="text-center py-8 text-red-600" style="display: none;">
        <p class="text-sm">Error al cargar recursos.</p>
    </div>

    <!-- Ensamble section -->
    <div class="main-category-section mb-16">
        <h2 class="text-3xl font-serif font-medium mb-12 text-center">Canciones para Ensamble Estudiantil</h2>

        <!-- Ensamble Principiante -->
        <div id="category-ensamble_principiante" class="category-section mb-12">
            <h3 class="text-2xl font-serif font-medium mb-8 text-center">Principiante</h3>
            <div class="resource-grid grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                <div class="col-span-full text-center py-8 text-muted">
                    <p class="text-sm">Cargando recursos...</p>
                </div>
            </div>
        </div>

        <!-- Ensamble Intermedio -->
        <div id="category-ensamble_intermedio" class="category-section mb-12">
            <h3 class="text-2xl font-serif font-medium mb-8 text-center">Intermedio</h3>
            <div class="resource-grid grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                <div class="col-span-full text-center py-8 text-muted">
                    <p class="text-sm">Cargando recursos...</p>
                </div>
            </div>
        </div>

        <!-- Ensamble Avanzado -->
        <div id="category-ensamble_avanzado" class="category-section mb-12">
            <h3 class="text-2xl font-serif font-medium mb-8 text-center">Avanzado</h3>
            <div class="resource-grid grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                <div class="col-span-full text-center py-8 text-muted">
                    <p class="text-sm">Cargando recursos...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Solista section -->
    <div class="main-category-section mb-16">
        <h2 class="text-3xl font-serif font-medium mb-12 text-center">Arreglos para Guitarra Solista</h2>

        <!-- Solista Principiante -->
        <div id="category-solista_principiante" class="category-section mb-12">
            <h3 class="text-2xl font-serif font-medium mb-8 text-center">Principiante</h3>
            <div class="resource-grid grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                <div class="col-span-full text-center py-8 text-muted">
                    <p class="text-sm">Cargando recursos...</p>
                </div>
            </div>
        </div>

        <!-- Solista Intermedio -->
        <div id="category-solista_intermedio" class="category-section mb-12">
            <h3 class="text-2xl font-serif font-medium mb-8 text-center">Intermedio</h3>
            <div class="resource-grid grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                <div class="col-span-full text-center py-8 text-muted">
                    <p class="text-sm">Cargando recursos...</p>
                </div>
            </div>
        </div>

        <!-- Solista Avanzado -->
        <div id="category-solista_avanzado" class="category-section mb-12">
            <h3 class="text-2xl font-serif font-medium mb-8 text-center">Avanzado</h3>
            <div class="resource-grid grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                <div class="col-span-full text-center py-8 text-muted">
                    <p class="text-sm">Cargando recursos...</p>
                </div>
            </div>
        </div>
    </div>
 

 </div>

  <script>
      let isLoading = false;
      let retryCount = 0;
      const maxRetries = 3;

      async function loadResources() {
          if (isLoading) return;
          isLoading = true;

          const loadingEl = document.getElementById('resources-loading');
          const errorEl = document.getElementById('resources-error');

          try {
              if (loadingEl) loadingEl.style.display = 'block';
              if (errorEl) errorEl.style.display = 'none';

              console.log('Loading resources... Starting fetch to /api/resources');
              const response = await fetch('/api/resources');
              console.log('Fetch response received:', response.status, response.statusText);

              if (!response.ok) {
                  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }

              const resources = await response.json();
              console.log('Resources parsed successfully:', Object.keys(resources));

              updateResources(resources);

              if (loadingEl) loadingEl.style.display = 'none';

          } catch (error) {
              console.error('Detailed error loading resources:', error);
              if (loadingEl) loadingEl.style.display = 'none';
              if (retryCount < maxRetries) {
                  retryCount++;
                  console.log(`Retrying loadResources in 2s (attempt ${retryCount}/${maxRetries})`);
                  setTimeout(() => loadResources(), 2000);
              } else {
                  if (errorEl) {
                      errorEl.style.display = 'block';
                      errorEl.innerHTML = '<p>Error al cargar recursos después de varios intentos.</p><button onclick="loadResources()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded">Reintentar</button>';
                  }
              }
          } finally {
              isLoading = false;
          }
      }

      function updateResources(resources: any) {
          const mainCategories = ['ensamble', 'solista'];
          const subCategories = ['principiante', 'intermedio', 'avanzado'];
          const categoryPrefixes = {
              ensamble_principiante: 'Canciones para ensamble estudiantil',
              ensamble_intermedio: 'Canciones para ensamble estudiantil',
              ensamble_avanzado: 'Canciones para ensamble estudiantil',
              solista_principiante: 'Arreglos para guitarra solista',
              solista_intermedio: 'Arreglos para guitarra solista',
              solista_avanzado: 'Arreglos para guitarra solista'
          };

          mainCategories.forEach(mainCat => {
              subCategories.forEach(subCat => {
                  const categoryKey = `${mainCat}_${subCat}`;
                  const categoryResources = resources[mainCat]?.[subCat] || {};
                  const categoryEl = document.getElementById(`category-${categoryKey}`);

                  if (!categoryEl) return;

                  const gridEl = categoryEl.querySelector('.resource-grid');
                  if (!gridEl) return;

                  // Clear existing content
                  gridEl.innerHTML = '';

                  const resourceNames = Object.keys(categoryResources);
                  if (resourceNames.length === 0) {
                      gridEl.innerHTML = '<div class="col-span-full text-center py-8 text-muted"><p class="text-sm">No hay recursos en esta categoría aún.</p></div>';
                      return;
                  }

                  resourceNames.forEach(name => {
                      const files = categoryResources[name];
                      const card = createResourceCard(name, files, categoryKey);
                      gridEl.appendChild(card);
                  });
              });
          });
      }

      function createResourceCard(name: string, files: any, categoryKey: string) {
          const card = document.createElement('div');
          card.className = 'resource-card bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow';

          const categoryPrefixes = {
              ensamble_principiante: 'Canciones para ensamble estudiantil',
              ensamble_intermedio: 'Canciones para ensamble estudiantil',
              ensamble_avanzado: 'Canciones para ensamble estudiantil',
              solista_principiante: 'Arreglos para guitarra solista',
              solista_intermedio: 'Arreglos para guitarra solista',
              solista_avanzado: 'Arreglos para guitarra solista'
          };

          const title = document.createElement('h3');
          title.className = 'text-lg font-medium mb-4 text-center capitalize text-black';
          title.textContent = `${categoryPrefixes[categoryKey]}: ${name.replace(/[-_]/g, ' ')}`;
          card.appendChild(title);

         const buttonContainer = document.createElement('div');
         buttonContainer.className = 'flex flex-wrap gap-2 justify-center';

         if (files.pdf) {
             const pdfBtn = createDownloadButton('PDF', files.pdf, name, 'pdf', 'blue');
             buttonContainer.appendChild(pdfBtn);
         }

         if (files.mscz) {
             const msczBtn = createDownloadButton('MSCZ', files.mscz, name, 'mscz', 'green');
             buttonContainer.appendChild(msczBtn);
         }

          if (files.ogg) {
              const audioDiv = document.createElement('div');
              audioDiv.className = 'audio-preview mt-3 w-full flex justify-center';
              const audio = document.createElement('audio');
              audio.controls = true;
              audio.className = 'audio-player';
              audio.preload = 'none';
              audio.style.maxWidth = '200px';
              audio.style.width = '100%';
              audio.style.height = '40px';

              const source = document.createElement('source');
              source.src = files.ogg;
              source.type = 'audio/ogg';
              audio.appendChild(source);
              audio.appendChild(document.createTextNode('Tu navegador no soporta reproducción de audio.'));

              audioDiv.appendChild(audio);
              buttonContainer.appendChild(audioDiv);
          }

          if (files.mp3) {
              const audioDiv = document.createElement('div');
              audioDiv.className = 'audio-preview mt-3 w-full flex justify-center';
              const audio = document.createElement('audio');
              audio.controls = true;
              audio.className = 'audio-player';
              audio.preload = 'none';
              audio.style.maxWidth = '200px';
              audio.style.width = '100%';
              audio.style.height = '40px';

              const source = document.createElement('source');
              source.src = files.mp3;
              source.type = 'audio/mpeg';
              audio.appendChild(source);
              audio.appendChild(document.createTextNode('Tu navegador no soporta reproducción de audio.'));

              audioDiv.appendChild(audio);
              buttonContainer.appendChild(audioDiv);
          }

         card.appendChild(buttonContainer);

         const countDiv = document.createElement('div');
         countDiv.className = 'mt-4 text-xs text-gray-500 text-center';
         const count = Object.keys(files).length;
         countDiv.textContent = `${count} archivo${count !== 1 ? 's' : ''} disponible${count !== 1 ? 's' : ''}`;
         card.appendChild(countDiv);

         return card;
     }

       function createDownloadButton(text: string, dataUrl: string, name: string, ext: string, color: string) {
          const btn = document.createElement('a');
          btn.href = dataUrl;
          btn.download = `${name.replace(/[-_]/g, ' ')}.${ext}`;

          // Use better contrast colors that work with the site's theme
          let bgColor, textColor, hoverColor, borderColor;
          if (color === 'blue') {
              bgColor = 'bg-blue-600';
              textColor = 'text-white';
              hoverColor = 'hover:bg-blue-700';
              borderColor = 'border-blue-600 hover:border-blue-700';
          } else if (color === 'green') {
              bgColor = 'bg-green-600';
              textColor = 'text-white';
              hoverColor = 'hover:bg-green-700';
              borderColor = 'border-green-600 hover:border-green-700';
          } else {
              // Fallback
              bgColor = 'bg-gray-600';
              textColor = 'text-white';
              hoverColor = 'hover:bg-gray-700';
              borderColor = 'border-gray-600 hover:border-gray-700';
          }

          btn.className = `inline-flex items-center px-3 py-2 text-sm font-medium ${textColor} ${bgColor} border ${borderColor} rounded-md ${hoverColor} transition-colors`;
          btn.title = `Descargar ${ext.toUpperCase()}`;
          btn.textContent = text;
          return btn;
      }

      // Load resources when page loads
      document.addEventListener('astro:page-load', () => {
          loadResources();
      });
 </script>

 <style>
    .resource-card {
        transition: all 0.2s ease-in-out;
    }

    .resource-card:hover {
        transform: translateY(-2px);
    }

    .audio-preview {
        margin-top: 0.75rem;
        width: 100%;
        display: flex;
        justify-content: center;
    }

    .audio-player {
        width: 100%;
        max-width: 200px;
        height: 40px;
        border-radius: 6px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        outline: none;
    }

    .audio-player:focus {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
    }

    /* Ocultar barra de progreso y controles de tiempo para diseño minimalista */
    .audio-player::-webkit-media-controls-timeline,
    .audio-player::-webkit-media-controls-current-time-display,
    .audio-player::-webkit-media-controls-time-remaining-display {
        display: none !important;
    }

    /* Firefox */
    .audio-player::-moz-range-track {
        display: none;
    }

    /* Responsive */
    @media (max-width: 640px) {
        .audio-player {
            max-width: 150px;
            height: 36px;
        }
    }
</style>