---
import Button from './Button.astro';
import siteConfig from '../data/site-config';
import { getTranslations } from '../utils/i18n';

const currentLocale = Astro.currentLocale || 'es';
const translations = await getTranslations(currentLocale);

const subscribe = {
    title: translations.subscribe_title,
    text: translations.subscribe_text,
    formUrl: siteConfig.subscribe?.formUrl || '#'
};

const { class: className } = Astro.props;

// Control de visibilidad - cambiar a true para mostrar newsletter
const showSubscribe = false;
---

{
    showSubscribe && subscribe?.formUrl && (
        <section class:list={['px-8 py-12 flex flex-col items-center border border-dashed border-main text-center sm:px-12 sm:py-16', className]}>
            {subscribe.title && (
                <h2 class:list={['w-full max-w-xl text-2xl leading-tight font-serif font-medium sm:text-4xl', subscribe.text ? 'mb-4' : 'mb-8']}>
                    {subscribe.title}
                </h2>
            )}
            {subscribe.text && <p class="w-full max-w-xl mb-8 text-sm leading-normal">{subscribe.text}</p>}
            <form
                id="subscribe-form"
                name="subscribe-form"
                class="w-full max-w-xl flex flex-col gap-3.5 sm:flex-row"
            >
                <label for="email" class="sr-only">
                    Email Address
                </label>
                <input
                    type="email"
                    name="email"
                    id="email"
                    class="w-full h-9 px-5 py-2 text-sm text-main bg-transparent border border-main rounded-full placeholder:text-main/60 focus:outline-none"
                    required=""
                    value=""
                    placeholder="Your email"
                />
                <Button type="submit" name="subscribe" class="w-full h-9 sm:w-auto">
                    {translations.subscribe_button}
                </Button>
            </form>

            <div id="subscribe-message" class="hidden mt-4 p-3 bg-green-100 text-green-800 rounded-md"></div>

            <script>
                document.getElementById('subscribe-form')?.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const form = e.target as HTMLFormElement;
                    const email = (form.email as HTMLInputElement).value;
                    const button = form.querySelector('button') as HTMLButtonElement;
                    const messageDiv = document.getElementById('subscribe-message') as HTMLDivElement;

                    if (!email) {
                        messageDiv.className = 'mt-4 p-3 bg-red-100 text-red-800 rounded-md';
                        messageDiv.textContent = 'Por favor ingresa un email válido';
                        messageDiv.classList.remove('hidden');
                        return;
                    }

                    button.disabled = true;
                    button.textContent = 'Suscribiendo...';

                    try {
                        const response = await fetch('/api/subscribe', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ email })
                        });

                        const result = await response.json();

                        if (response.ok) {
                            messageDiv.className = 'mt-4 p-3 bg-green-100 text-green-800 rounded-md';
                            messageDiv.textContent = '¡Suscripción exitosa! Revisa tu email.';
                            form.reset();
                        } else {
                            throw new Error(result.error || 'Error en la suscripción');
                        }
                    } catch (error) {
                        messageDiv.className = 'mt-4 p-3 bg-red-100 text-red-800 rounded-md';
                        messageDiv.textContent = 'Error: ' + (error as Error).message;
                    } finally {
                        messageDiv.classList.remove('hidden');
                        button.disabled = false;
                        button.textContent = 'Suscribirse';
                    }
                });
            </script>
        </section>
    )
}
